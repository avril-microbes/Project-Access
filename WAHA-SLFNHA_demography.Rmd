---
title: "WAHA-SLFNHA_demography"
output: html_document
runtime: shiny
self_contained: true
---
# Introduction
Code for visualization of First Nations communities served by the Weeneebayko Area Health Authority (WAHA) and the Sioux Lookout First Nations Health Authority (SLFNHA). All data is compiled from the 2016 Canadian Census.

## Data Processing
### Load packages
```{r, message=FALSE, results='hide'}
library(dplyr)
library(tmap)
library(sf)
library(cancensus)
library(here)
library(stringr)
library(rgdal)
library(ggplot2)
library(shiny)

# load API key for Cancensus. Replace with custom
api_key <- readr::read_file(here("census_api.txt"))
options(cancensus.api_key = api_key)
```


### Process Data
#### Retrieving SGC of communities served
```{r}
# list of communities served by WAHA
waha_com <- data.frame(communities = c("Attawapiskat", "Fort Albany", "Kashechewan", "Moosonee", "Peawanuck", "Moose Factory"))

# list of communities served by SLFNHA
slf_com <- read.delim(here("slf_com.txt"), header = F)

# import in Standard Geographical Classification (SGC) 2016 from https://www.statcan.gc.ca/en/subjects/standard/sgc/2016/index
sgc <- read.csv(here("SGC-CGT-2016-Element-eng.csv"))
## rename
names(sgc) <- c("level", "Code", "Title", "Element", "Name")
## remove trailing white space
sgc$Name <- trimws(sgc$Name)
## process sgc to remove numbers after name
sgc$Name2 <- trimws(gsub("\\d+.*", "", sgc$Name))

# filter by communities. Remove unorganized given those contain larger aggregated data. Kashechewan grouped under Fort Albany
waha_sgc <- sgc %>% 
  filter(Name2 %in% waha_com$communities) %>% 
  filter(!(grepl("Unorganized", Title))) %>% 
  filter(!duplicated(Code))

# for SLFNHA, multiple locations in ontario for a single name. Calculate mean string distance and select the location with closest string match.
slf_sgc <- sgc %>% 
  filter(Name2 %in% slf_com$V1) %>% 
  filter(!(grepl("Unorganized", Title))) %>% 
  filter(substr(Code, 1, 1) == 3)
### function to calculate distance between Title and Name
slf_sgc$str_diff <- mapply(function(x,y) mean(adist(c(x, y), counts = T)), slf_sgc$Title, slf_sgc$Name)
### select the locations lowest string difference. 23 communities found with geo code.
slf_sgc <- slf_sgc %>% 
  dplyr::group_by(Name2) %>% 
  dplyr::arrange(str_diff, .by_group = T) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()

# what are they? These have data on census. No info on Koocheching 
slf_com$V1[!(slf_com$V1 %in% slf_sgc$Name2)]
```

### Retrieving Census data
```{r, message=FALSE,results='hide'}
waha_census <- get_census(dataset = "CA16",
           regions = list(CSD = waha_sgc$Code),
           level = "CSD",
           vectors = c("v_CA16_401", "v_CA16_404", "v_CA16_406", "v_CA16_407",
                       "v_CA16_4", "v_CA16_61","v_CA16_244", "v_CA16_379", "v_CA16_425", "v_CA16_512"),
           geo_format = "sf")

slf_census <- get_census(dataset = "CA16",
           regions = list(CSD = slf_sgc$Code),
           level = "CSD",
           vectors = c("v_CA16_401", "v_CA16_404", "v_CA16_406", "v_CA16_407",
                       "v_CA16_4", "v_CA16_61","v_CA16_244", "v_CA16_379", "v_CA16_425", "v_CA16_512"),
           geo_format = "sf")
```

# Edit census info
Moose factory has a population of 0. Hence, need to correct to the data for Designated Location Moose Factory South. McDowell Lake is also designated as having 0 population. The community, in fact, has 59. https://kochiefs.ca/mcdowell_lake
```{r}
# process moose factory data
moose_factory.df <- read.csv(here("census_ind/moosefactory_geography.csv"), header = F)

var_ls <- c("Population; 2016", "Total private dwellings", "Population density per square kilometre", "Land area in square kilometres", "Average household size", "  0 to 14 years", "  15 to 64 years",  "  65 years and over", "Average age of the population", "Total - Knowledge of official languages for the total population excluding institutional residents - 100% data")

names(moose_factory.df) <- c("Characteristics", "Note",	"Total",	"Flag_Total",	"Male",	"Flag_Male",	"Female")

moose_factory.df <- moose_factory.df %>% 
  filter(Characteristics %in% var_ls) %>% 
  filter(!duplicated(Characteristics)) %>% 
  select(Characteristics, Total)

moose_factory.df2 <- data.frame(t(moose_factory.df[,-1]))
names(moose_factory.df2) <- moose_factory.df$Characteristics
moose_factory.df2 <- moose_factory.df2[,c(1,2,3,4,9,5,6,7,8,10)]
names(moose_factory.df2) <- names(waha_census)[13:22]
moose_factory.df2$name <- "Moose Factory"

moose_factory.df2$geometry <- waha_census$geometry[waha_census$name == "Moose Factory 68 (IRI)"]
moose_factory.sf <- st_as_sf(moose_factory.df2)

waha_census2 <- rbind(waha_census[c(9, 13:22)], moose_factory.sf) 

# remove original moose factory data
waha_census2 <- waha_census2[-c(2),]
```

Manually change McDowell Lake population
```{r}
slf_census$`v_CA16_401: Population, 2016`[[30]] <- 59
slf_census2 <- slf_census[c(9,13:22)]
```

# prepare for plotting
```{r}
# get centroid (polygons too small)
waha_cent <- st_centroid(waha_census2)
slf_cent <- st_centroid(slf_census)

# become nuermic
waha_census2$`v_CA16_401: Population, 2016` <- as.numeric(waha_census2$`v_CA16_401: Population, 2016`)

#
slf_census2$health <- "SLFNHA"
waha_census2$health <- "WAHA"
waha_slf.census2 <- rbind(slf_census2, waha_census2)
waha_slf.census2 <- waha_slf.census2 %>% 
  mutate_at(c(2:11), as.numeric)
```

```{r}
world_vars <- names(st_drop_geometry(waha_slf.census2[2:11]))

ui <- fluidPage(
  tmapOutput("map"),
  selectInput("var", "Variable", world_vars)
)

server <- function(input, output, session) {
  output$map <- renderTmap({
    tm_shape(waha_slf.census2) +
  tm_dots(col = input$var, size = input$var,id = c("name"),
popup.vars = c("Health Authority:" = "health",
               "Variable:" = input$var), title = "Variable")
  })
}	


shinyApp(ui, server,  options = list(height = 800))
```

